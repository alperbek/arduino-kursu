var Oauth2=function(){function e(e){if(window.self===window.top){localStorage.removeItem("oauth_token"),this.opts=this.defaults(e);var t=this.getCookie("arduino_authenticated");t&&"false"!==t||sessionStorage.removeItem("oauth_token");var o=sessionStorage.getItem("oauth_clientId");o&&this.opts.clientID!==o&&sessionStorage.removeItem("oauth_token");var r=this.getTokenFromHash(window.location,this.opts.params);if(""!==r.token)return this.putInSession(r),void this.redirect();sessionStorage.setItem("oauth_redirect",window.location.href),sessionStorage.setItem("oauth_clientId",this.opts.clientID)}}return e.prototype.login=function(e){sessionStorage.setItem("oauth_redirect",e||window.location.href),window.location.href=this.redirectURI()},e.prototype.logout=function(e){sessionStorage.removeItem("oauth_redirect"),sessionStorage.removeItem("oauth_token"),sessionStorage.removeItem("oauth_clientId"),window.location.href=this.logoutURI(e)},e.prototype.redirectURI=function(){var e=encodeURIComponent(this.opts.redirectURI),t=Math.random().toString(36).substr(2,8),o=this.opts.scopes.join("%20");return this.opts.authURI+"?client_id="+this.opts.clientID+"&state="+t+"&scope="+o+"&response_type=token&redirect_uri="+e},e.prototype.logoutURI=function(e){var t;t=e?encodeURIComponent(e):encodeURIComponent(this.opts.redirectURI);return this.opts.logoutURI+"?redirect_uri="+t},e.prototype.tokenPromise=void 0,e.prototype.token=function(){if(window.self!==window.top)return Promise.reject("inside iframe");var t;t=this.getFromSession();var o=new Date(Date.now()-1e4),r=this;return t&&t.expires&&t.expires<o&&(e.prototype.tokenPromise=void 0),e.prototype.tokenPromise||(e.prototype.tokenPromise=new Promise(function(e,n){return t&&t.expires&&t.expires>o?e(t):"true"===r.getCookie("arduino_authenticated")?r.refresh().then(function(t){return e(t)}).catch(function(e){return n(e)}):n("LOGGED OUT")})),e.prototype.tokenPromise},e.prototype.redirect=function(){var e=sessionStorage.getItem("oauth_redirect");e&&(sessionStorage.removeItem("oauth_redirect"),window.location.href=e)},e.prototype.defaults=function(e){return e.params||(e.params={}),e.params.token||(e.params.token="access_token"),e.params.expires||(e.params.expires="expires_in"),e.params.type||(e.params.type="token_type"),e.params.scope||(e.params.scope="scope"),e.authURI||console.error("Oauth2: the property authURI is missing"),e},e.prototype.refresh=function(){var e=this;return new Promise(function(t,o){var r=document.createElement("iframe");r.setAttribute("src",e.redirectURI()),r.setAttribute("height","0"),r.setAttribute("width","0");var n=e.getTokenFromHash;r.onload=function(){var i=n(this.contentWindow.location,e.opts.params);document.body.removeChild(r),""===i.token?o("token not found"):(e.putInSession(i),t(i))},r.onerror=function(e){o(e)},document.body.appendChild(r)})},e.prototype.getTokenFromHash=function(e,t){function o(e,t){for(var o=0;o<e.length;o++){var r=e[o].split("="),n=r[0],i=r[1];if(n===t)return i}return""}var r,n={token:"",scope:"",expires:new Date(0),type:""};try{r=e.hash.substring(1)}catch(e){return n}var i=r.split("&");n.token=o(i,t.token);var s=parseInt(o(i,t.expires));return n.expires=new Date(Date.now()+1e3*s),n.scope=o(i,t.scope),n.type=o(i,t.type),n},e.prototype.putInSession=function(e){if("object"==typeof e){var t=JSON.stringify(e);sessionStorage.setItem("oauth_token",t)}},e.prototype.getFromSession=function(){var e=sessionStorage.getItem("oauth_token");try{var t=JSON.parse(e);return t.expires=new Date(t.expires),t}catch(e){return null}},e.prototype.getCookie=function(e){var t=" "+document.cookie,o=t.indexOf(" "+e+"=");if(-1===o)t=null;else{o=t.indexOf("=",o)+1;var r=t.indexOf(";",o);-1===r&&(r=t.length),t=decodeURI(t.substring(o,r))}return t},e}();